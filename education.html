<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="education.css">
    <title>Higher Education Opportunities</title>
    
    <!-- Firebase SDK -->
    <script type="module" src="firebase-simple.js"></script>
   
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>Higher Education Opportunities</h1>
                <p>Discover scholarships, graduate programs, and research opportunities worldwide</p>
            </div>
            <button class="share-btn" id="share-opportunity-btn">
                <span>+</span> Share Opportunity
            </button>
        </div>

        <div class="filters">
            <input type="text" class="search-input" placeholder="Search opportunities or institutions..." id="search-input">
            <select class="filter-select" id="type-filter">
                <option value="">All Types</option>
                <option value="phd">PhD</option>
                <option value="masters">Masters</option>
                <option value="research">Research</option>
                <option value="scholarship">Scholarship</option>
            </select>
            <select class="filter-select" id="country-filter">
                <option value="">All Countries</option>
                <option value="canada">Canada</option>
                <option value="usa">USA</option>
                <option value="uk">United Kingdom</option>
                <option value="germany">Germany</option>
                <option value="australia">Australia</option>
            </select>
        </div>

        <div class="results-info">
            <span id="results-count">Showing 5 opportunities</span>
        </div>

        <div class="featured-section">
            <h2>Featured Opportunities</h2>
            <div class="featured-flex" id="opportunities-container">
                <!-- Opportunities will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Share Opportunity Modal -->
    <div class="modal" id="share-opportunity-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Share Education Opportunity</h2>
                <button class="close-btn" id="close-modal">&times;</button>
            </div>
            <form id="share-opportunity-form">
                <div class="form-group">
                    <label for="opportunity-title">Opportunity Title *</label>
                    <input type="text" id="opportunity-title" name="title" required>
                </div>
                <div class="form-group">
                    <label for="university">University/Institution *</label>
                    <input type="text" id="university" name="university" required>
                </div>
                <div class="form-group">
                    <label for="country">Country *</label>
                    <input type="text" id="country" name="country" required>
                </div>
                <div class="form-group">
                    <label for="opportunity-type">Opportunity Type *</label>
                    <select id="opportunity-type" name="opportunity_type" required>
                        <option value="">Select Type</option>
                        <option value="phd">PhD Program</option>
                        <option value="masters">Masters Program</option>
                        <option value="research">Research Position</option>
                        <option value="scholarship">Scholarship</option>
                        <option value="fellowship">Fellowship</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="funding">Funding Details</label>
                    <select id="funding" name="funding">
                        <option value="">Select Funding</option>
                        <option value="full-funding">Full Funding</option>
                        <option value="partial-scholarship">Partial Scholarship</option>
                        <option value="self-funded">Self Funded</option>
                        <option value="assistantship">Teaching/Research Assistantship</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="deadline">Application Deadline</label>
                    <input type="date" id="deadline" name="deadline">
                </div>
                <div class="form-group">
                    <label for="opportunity-description">Description *</label>
                    <textarea id="opportunity-description" name="description" required placeholder="Describe the opportunity, requirements, and application process..."></textarea>
                </div>
                <div class="form-group">
                    <label for="requirements">Requirements (comma-separated)</label>
                    <input type="text" id="requirements" name="requirements" placeholder="e.g., Bachelor's degree, IELTS 7.0, GPA 3.5">
                </div>
                <div class="form-group">
                    <label for="application-url">Application/More Info URL</label>
                    <input type="url" id="application-url" name="application_url" placeholder="https://...">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancel-share">Cancel</button>
                    <button type="submit" class="btn-primary">Share Opportunity</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // Import Firebase API (using global window.FirebaseAPI)
        await import('./firebase-simple.js');
        
        let currentUser = null;
        let allOpportunities = []; // Store all opportunities for filtering

        // Check authentication on page load
        window.onload = function() {
            checkAuthentication();
            loadOpportunities();
        };

        // Check if user is authenticated
        function checkAuthentication() {
            const storedUser = localStorage.getItem('user_info');
            const credential = localStorage.getItem('google_credential');
            
            if (storedUser && credential) {
                currentUser = JSON.parse(storedUser);
                document.getElementById('share-opportunity-btn').style.display = 'flex';
                updateHeaderWithUser(currentUser);
            } else {
                // No authentication - show share button but it will trigger login
                document.getElementById('share-opportunity-btn').style.display = 'flex';
                document.getElementById('share-opportunity-btn').innerHTML = '<span>+</span> Share Opportunity (Sign in required)';
            }
        }

        // Show loading state
        function showLoading() {
            document.getElementById('opportunities-container').innerHTML = '<p>Loading education opportunities...</p>';
        }

        // Update header with user information
        function updateHeaderWithUser(user) {
            const headerContent = document.querySelector('.header-content');
            if (headerContent && !document.getElementById('user-info')) {
                const userInfo = document.createElement('div');
                userInfo.id = 'user-info';
                userInfo.style.cssText = 'margin-top: 10px; font-size: 14px; opacity: 0.8;';
                userInfo.innerHTML = `
                    Welcome back, ${user.displayName || user.email}! 
                    <button onclick="logoutUser()" style="margin-left: 10px; padding: 5px 10px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 4px; cursor: pointer;">Sign Out</button>
                `;
                headerContent.appendChild(userInfo);
            }
        }

        // Logout function
        window.logoutUser = function() {
            // Clear local storage
            localStorage.removeItem('google_credential');
            localStorage.removeItem('user_info');
            
            // Redirect to login
            window.location.href = 'login.html';
        };

        // Modal functionality
        const modal = document.getElementById('share-opportunity-modal');
        const shareBtn = document.getElementById('share-opportunity-btn');
        const closeModal = document.getElementById('close-modal');
        const cancelShare = document.getElementById('cancel-share');

        shareBtn.addEventListener('click', () => {
            if (!currentUser) {
                // Redirect to login page when user tries to share
                window.location.href = 'login.html?redirect=education.html';
                return;
            }
            modal.style.display = 'block';
        });

        closeModal.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        cancelShare.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });

        // Share opportunity form submission
        document.getElementById('share-opportunity-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) {
                alert('Please log in to share an opportunity');
                return;
            }

            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Sharing Opportunity...';
            submitBtn.disabled = true;

            const formData = new FormData(e.target);
            const opportunityData = {
                title: formData.get('title'),
                university: formData.get('university'),
                country: formData.get('country'),
                opportunity_type: formData.get('opportunity_type'),
                funding: formData.get('funding'),
                deadline: formData.get('deadline'),
                description: formData.get('description'),
                requirements: formData.get('requirements'),
                application_url: formData.get('application_url'),
                firebase_uid: currentUser.uid, // Google ID
                poster_name: currentUser.displayName || currentUser.email,
                user_type: currentUser.user_type || 'User'
            };

            try {
                const result = await window.FirebaseAPI.createEducationOpportunity(opportunityData);
                
                alert('Opportunity shared successfully!');
                modal.style.display = 'none';
                e.target.reset();
                loadOpportunities();
            } catch (error) {
                console.error('Error sharing opportunity:', error);
                alert('Failed to share opportunity: ' + error.message);
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // Load opportunities from backend
        async function loadOpportunities() {
            showLoading();
            
            try {
                const opportunities = await window.FirebaseAPI.getEducationOpportunities();
                allOpportunities = opportunities; // Store for filtering
                displayOpportunities(opportunities);
            } catch (error) {
                console.error('Error loading opportunities:', error);
                document.getElementById('opportunities-container').innerHTML = 
                    '<p>Failed to load education opportunities. Please refresh the page and try again.</p>';
            }
        }

        // Add this function to handle description truncation and see more functionality

        function truncateDescription(text, maxLength = 200) {
            if (text.length <= maxLength) {
                return { truncated: text, needsExpansion: false };
            }
            
            // Find a good breaking point (end of sentence or word)
            let truncated = text.substring(0, maxLength);
            const lastPeriod = truncated.lastIndexOf('.');
            const lastSpace = truncated.lastIndexOf(' ');
            
            if (lastPeriod > maxLength - 50) {
                truncated = truncated.substring(0, lastPeriod + 1);
            } else if (lastSpace > maxLength - 20) {
                truncated = truncated.substring(0, lastSpace);
            }
            
            return { truncated: truncated + '...', needsExpansion: true };
        }

        function createOpportunityCard(opportunity) {
            const { truncated, needsExpansion } = truncateDescription(opportunity.description || '');
            
            return `
                <div class="opportunity-card">
                    <div class="opportunity-header">
                        <div class="opportunity-tags">
                            <span class="tag ${opportunity.type === 'phd' ? 'phd-tag' : 'masters-tag'}">
                                ${opportunity.type || 'opportunity'}
                            </span>
                            ${opportunity.country ? `<span class="tag country-tag">${opportunity.country}</span>` : ''}
                            ${opportunity.funding === 'full funding' ? '<span class="tag scholarship-tag">full funding</span>' : ''}
                        </div>
                        
                        <h3 class="opportunity-title">${opportunity.title || 'Untitled Opportunity'}</h3>
                        
                        <div class="opportunity-institution">
                            <span>🏛️</span>
                            <span>${opportunity.institution || 'Institution not specified'}</span>
                        </div>
                    </div>
                    
                    <div class="opportunity-description">
                        <div class="description-text" id="desc-${opportunity.id}">
                            ${truncated}
                        </div>
                        ${needsExpansion ? `
                            <button class="see-more-btn" onclick="toggleDescription('${opportunity.id}', \`${opportunity.description.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)">
                                see more
                            </button>
                        ` : ''}
                    </div>
                    
                    <div class="opportunity-footer">
                        <div class="opportunity-meta">
                            <span>Posted by ${opportunity.posted_by || 'Alumni'}</span>
                            <span class="deadline">
                                <strong>Deadline:</strong> ${opportunity.deadline || 'Not specified'}
                            </span>
                        </div>
                        
                        <div class="opportunity-actions">
                            <button class="save-btn" onclick="saveOpportunity('${opportunity.id}')">
                                🤍 Save
                            </button>
                            <button class="apply-btn">
                                Apply
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleDescription(opportunityId, fullDescription) {
            const descElement = document.getElementById(`desc-${opportunityId}`);
            const btn = descElement.nextElementSibling;
            
            if (descElement.classList.contains('expanded')) {
                // Collapse
                const { truncated } = truncateDescription(fullDescription);
                descElement.textContent = truncated;
                descElement.classList.remove('expanded');
                btn.textContent = 'see more';
            } else {
                // Expand
                descElement.textContent = fullDescription;
                descElement.classList.add('expanded');
                btn.textContent = 'see less';
            }
        }

        // Update the displayOpportunities function to use the new card creation
        async function displayOpportunities() {
            const container = document.getElementById('opportunities-container');
            
            if (!container) {
                console.error('Opportunities container not found');
                return;
            }
            
            try {
                const opportunities = await window.FirebaseAPI.getEducationOpportunities();
                
                if (opportunities.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #6b7280;">
                            <h3>No opportunities available yet</h3>
                            <p>Be the first to share an educational opportunity!</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = opportunities.map(opportunity => 
                    createOpportunityCard(opportunity)
                ).join('');
                
            } catch (error) {
                console.error('Error displaying opportunities:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #ef4444;">
                        <h3>Error loading opportunities</h3>
                        <p>Please try refreshing the page.</p>
                    </div>
                `;
            }
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        // Search and filter functionality
        document.getElementById('search-input').addEventListener('input', filterOpportunities);
        document.getElementById('type-filter').addEventListener('change', filterOpportunities);
        document.getElementById('country-filter').addEventListener('change', filterOpportunities);

        function filterOpportunities() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const typeFilter = document.getElementById('type-filter').value;
            const countryFilter = document.getElementById('country-filter').value;

            let filteredOpportunities = allOpportunities.filter(opportunity => {
                const matchesSearch = !searchTerm || 
                    opportunity.title.toLowerCase().includes(searchTerm) ||
                    opportunity.university.toLowerCase().includes(searchTerm) ||
                    opportunity.country.toLowerCase().includes(searchTerm) ||
                    opportunity.description.toLowerCase().includes(searchTerm) ||
                    (opportunity.requirements && opportunity.requirements.toLowerCase().includes(searchTerm));

                const matchesType = !typeFilter || opportunity.opportunity_type === typeFilter;
                const matchesCountry = !countryFilter || opportunity.country.toLowerCase() === countryFilter.toLowerCase();

                return matchesSearch && matchesType && matchesCountry;
            });

            displayOpportunities(filteredOpportunities);
        }
    </script>

    <script>
        // Simple function to truncate long descriptions
        function addSeeMoreToLongDescriptions() {
            // Wait for content to load
            setTimeout(() => {
                const descriptions = document.querySelectorAll('.opportunity-description');
                
                descriptions.forEach((desc, index) => {
                    const text = desc.textContent.trim();
                    
                    if (text.length > 200) {
                        const truncated = text.substring(0, 200).trim() + '...';
                        const descId = `desc-${index}`;
                        
                        desc.innerHTML = `
                            <div class="description-text" id="${descId}">${truncated}</div>
                            <button class="see-more-btn" onclick="toggleDesc('${descId}', \`${text.replace(/`/g, '\\`')}\`)">
                                see more
                            </button>
                        `;
                    }
                });
            }, 1000);
        }

        function toggleDesc(id, fullText) {
            const element = document.getElementById(id);
            const btn = element.nextElementSibling;
            
            if (element.classList.contains('expanded')) {
                element.textContent = fullText.substring(0, 200) + '...';
                element.classList.remove('expanded');
                btn.textContent = 'see more';
            } else {
                element.textContent = fullText;
                element.classList.add('expanded');
                btn.textContent = 'see less';
            }
        }

        // Run when page loads
        document.addEventListener('DOMContentLoaded', addSeeMoreToLongDescriptions);
    </script>
</body>
</html>
