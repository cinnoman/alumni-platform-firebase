<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="education.css">
    <title>Higher Education Opportunities</title>
    
    <!-- Firebase SDK -->
    <script type="module" src="firebase-simple.js"></script>
   
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>Higher Education Opportunities</h1>
                <p>Discover scholarships, graduate programs, and research opportunities worldwide</p>
            </div>
            <button class="share-btn" id="share-opportunity-btn">
                <span>+</span> Share Opportunity
            </button>
        </div>

        <div class="filters">
            <input type="text" class="search-input" placeholder="Search opportunities or institutions..." id="search-input">
            <select class="filter-select" id="type-filter">
                <option value="">All Types</option>
                <option value="phd">PhD</option>
                <option value="masters">Masters</option>
                <option value="research">Research</option>
                <option value="scholarship">Scholarship</option>
            </select>
            <select class="filter-select" id="country-filter">
                <option value="">All Countries</option>
                <option value="canada">Canada</option>
                <option value="usa">USA</option>
                <option value="uk">United Kingdom</option>
                <option value="germany">Germany</option>
                <option value="australia">Australia</option>
            </select>
        </div>

        <div class="results-info">
            <span id="results-count">Showing 5 opportunities</span>
        </div>

        <div class="featured-section">
            <h2>Featured Opportunities</h2>
            <div class="featured-flex" id="opportunities-container">
                <!-- Opportunities will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Share Opportunity Modal -->
    <div class="modal" id="share-opportunity-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Share Education Opportunity</h2>
                <button class="close-btn" id="close-modal">&times;</button>
            </div>
            <form id="share-opportunity-form">
                <div class="form-group">
                    <label for="opportunity-title">Opportunity Title *</label>
                    <input type="text" id="opportunity-title" name="title" required>
                </div>
                <div class="form-group">
                    <label for="university">University/Institution *</label>
                    <input type="text" id="university" name="university" required>
                </div>
                <div class="form-group">
                    <label for="country">Country *</label>
                    <input type="text" id="country" name="country" required>
                </div>
                <div class="form-group">
                    <label for="opportunity-type">Opportunity Type *</label>
                    <select id="opportunity-type" name="opportunity_type" required>
                        <option value="">Select Type</option>
                        <option value="phd">PhD Program</option>
                        <option value="masters">Masters Program</option>
                        <option value="research">Research Position</option>
                        <option value="scholarship">Scholarship</option>
                        <option value="fellowship">Fellowship</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="funding">Funding Details</label>
                    <select id="funding" name="funding">
                        <option value="">Select Funding</option>
                        <option value="full-funding">Full Funding</option>
                        <option value="partial-scholarship">Partial Scholarship</option>
                        <option value="self-funded">Self Funded</option>
                        <option value="assistantship">Teaching/Research Assistantship</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="deadline">Application Deadline</label>
                    <input type="date" id="deadline" name="deadline">
                </div>
                <div class="form-group">
                    <label for="opportunity-description">Description *</label>
                    <textarea id="opportunity-description" name="description" required placeholder="Describe the opportunity, requirements, and application process..."></textarea>
                </div>
                <div class="form-group">
                    <label for="requirements">Requirements (comma-separated)</label>
                    <input type="text" id="requirements" name="requirements" placeholder="e.g., Bachelor's degree, IELTS 7.0, GPA 3.5">
                </div>
                <div class="form-group">
                    <label for="application-url">Application/More Info URL</label>
                    <input type="url" id="application-url" name="application_url" placeholder="https://...">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancel-share">Cancel</button>
                    <button type="submit" class="btn-primary">Share Opportunity</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // Import Firebase API (using global window.FirebaseAPI)
        await import('./firebase-simple.js');
        
        let currentUser = null;
        let allOpportunities = []; // Store all opportunities for filtering

        // Check authentication on page load
        window.onload = function() {
            checkAuthentication();
            loadOpportunities();
        };

        // Check if user is authenticated
        function checkAuthentication() {
            const storedUser = localStorage.getItem('user_info');
            const credential = localStorage.getItem('google_credential');
            
            if (storedUser && credential) {
                currentUser = JSON.parse(storedUser);
                document.getElementById('share-opportunity-btn').style.display = 'flex';
                updateHeaderWithUser(currentUser);
            } else {
                // No authentication - show share button but it will trigger login
                document.getElementById('share-opportunity-btn').style.display = 'flex';
                document.getElementById('share-opportunity-btn').innerHTML = '<span>+</span> Share Opportunity (Sign in required)';
            }
        }

        // Show loading state
        function showLoading() {
            document.getElementById('opportunities-container').innerHTML = '<p>Loading education opportunities...</p>';
        }

        // Update header with user information
        function updateHeaderWithUser(user) {
            const headerContent = document.querySelector('.header-content');
            if (headerContent && !document.getElementById('user-info')) {
                const userInfo = document.createElement('div');
                userInfo.id = 'user-info';
                userInfo.style.cssText = 'margin-top: 10px; font-size: 14px; opacity: 0.8;';
                userInfo.innerHTML = `
                    Welcome back, ${user.displayName || user.email}! 
                    <button onclick="logoutUser()" style="margin-left: 10px; padding: 5px 10px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 4px; cursor: pointer;">Sign Out</button>
                `;
                headerContent.appendChild(userInfo);
            }
        }

        // Logout function
        window.logoutUser = function() {
            // Clear local storage
            localStorage.removeItem('google_credential');
            localStorage.removeItem('user_info');
            
            // Redirect to login
            window.location.href = 'login.html';
        };

        // Modal functionality
        const modal = document.getElementById('share-opportunity-modal');
        const shareBtn = document.getElementById('share-opportunity-btn');
        const closeModal = document.getElementById('close-modal');
        const cancelShare = document.getElementById('cancel-share');

        shareBtn.addEventListener('click', () => {
            if (!currentUser) {
                // Redirect to login page when user tries to share
                window.location.href = 'login.html?redirect=education.html';
                return;
            }
            modal.style.display = 'block';
        });

        closeModal.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        cancelShare.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });

        // Share opportunity form submission
        document.getElementById('share-opportunity-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) {
                alert('Please log in to share an opportunity');
                return;
            }

            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Sharing Opportunity...';
            submitBtn.disabled = true;

            const formData = new FormData(e.target);
            const opportunityData = {
                title: formData.get('title'),
                university: formData.get('university'),
                country: formData.get('country'),
                opportunity_type: formData.get('opportunity_type'),
                funding: formData.get('funding'),
                deadline: formData.get('deadline'),
                description: formData.get('description'),
                requirements: formData.get('requirements'),
                application_url: formData.get('application_url'),
                firebase_uid: currentUser.uid, // Google ID
                poster_name: currentUser.displayName || currentUser.email,
                user_type: currentUser.user_type || 'User'
            };

            try {
                const result = await window.FirebaseAPI.createEducationOpportunity(opportunityData);
                
                alert('Opportunity shared successfully!');
                modal.style.display = 'none';
                e.target.reset();
                loadOpportunities();
            } catch (error) {
                console.error('Error sharing opportunity:', error);
                alert('Failed to share opportunity: ' + error.message);
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // Load opportunities from backend
        async function loadOpportunities() {
            showLoading();
            
            try {
                const opportunities = await window.FirebaseAPI.getEducationOpportunities();
                allOpportunities = opportunities; // Store for filtering
                displayOpportunities(opportunities);
            } catch (error) {
                console.error('Error loading opportunities:', error);
                document.getElementById('opportunities-container').innerHTML = 
                    '<p>Failed to load education opportunities. Please refresh the page and try again.</p>';
            }
        }

        // Display opportunities
        function displayOpportunities(opportunities) {
            const container = document.getElementById('opportunities-container');
            const resultsCount = document.getElementById('results-count');
            
            resultsCount.textContent = `Showing ${opportunities.length} opportunities`;
            
            if (opportunities.length === 0) {
                container.innerHTML = '<p>No education opportunities found matching your criteria.</p>';
                return;
            }

            const opportunitiesHTML = opportunities.map(opportunity => `
                <div class="opportunity-card">
                    <div class="opportunity-badges">
                        <span class="badge ${opportunity.opportunity_type}-badge">${opportunity.opportunity_type || 'opportunity'}</span>
                        <span class="badge country-badge">${opportunity.country || 'Global'}</span>
                    </div>
                    
                    <h3 class="opportunity-title">${opportunity.title}</h3>
                    
                    <div class="opportunity-institution">
                        <span class="institution-icon">🏛️</span>
                        <span>${opportunity.university}</span>
                    </div>
                    
                    <div class="opportunity-description">
                        ${opportunity.description}
                    </div>
                    
                    <div class="opportunity-meta">
                        <div class="meta-item">
                            <span class="meta-label">Posted by</span>
                            <span class="meta-value">${opportunity.poster_name || 'Alumni'}</span>
                        </div>
                        ${opportunity.deadline ? `
                            <div class="meta-item">
                                <span class="meta-label">Deadline</span>
                                <span class="meta-value">${formatDate(opportunity.deadline)}</span>
                            </div>
                        ` : ''}
                        ${opportunity.funding ? `
                            <div class="meta-item">
                                <span class="meta-label">Funding</span>
                                <span class="meta-value">${opportunity.funding}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="opportunity-actions">
                        <button class="save-btn">Save</button>
                        <button class="apply-btn">Apply</button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = opportunitiesHTML;
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        // Search and filter functionality
        document.getElementById('search-input').addEventListener('input', filterOpportunities);
        document.getElementById('type-filter').addEventListener('change', filterOpportunities);
        document.getElementById('country-filter').addEventListener('change', filterOpportunities);

        function filterOpportunities() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const typeFilter = document.getElementById('type-filter').value;
            const countryFilter = document.getElementById('country-filter').value;

            let filteredOpportunities = allOpportunities.filter(opportunity => {
                const matchesSearch = !searchTerm || 
                    opportunity.title.toLowerCase().includes(searchTerm) ||
                    opportunity.university.toLowerCase().includes(searchTerm) ||
                    opportunity.country.toLowerCase().includes(searchTerm) ||
                    opportunity.description.toLowerCase().includes(searchTerm) ||
                    (opportunity.requirements && opportunity.requirements.toLowerCase().includes(searchTerm));

                const matchesType = !typeFilter || opportunity.opportunity_type === typeFilter;
                const matchesCountry = !countryFilter || opportunity.country.toLowerCase() === countryFilter.toLowerCase();

                return matchesSearch && matchesType && matchesCountry;
            });

            displayOpportunities(filteredOpportunities);
        }
    </script>
</body>
</html>
